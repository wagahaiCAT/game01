tyrano.plugin.kag.menu={tyrano:null,kag:null,snap:null,init:function(){},showMenu:function(t){if("none"==this.kag.layer.layer_event.css("display")&&1!=this.kag.stat.is_strong_stop)return!1;if(1==this.kag.stat.is_wait)return!1;var e=this;this.kag.stat.is_skip=!1,this.kag.stat.is_auto=!1,this.kag.stat.is_auto_wait=!1;var a=this.kag.layer.getMenuLayer();a.empty();var n=!1;this.kag.html("menu",{novel:$.novel},function(t){var i=$(t);a.append(i),a.find(".menu_skip").click(function(t){a.html(""),a.hide(),1==e.kag.stat.visible_menu_button&&$(".button_menu").show(),e.kag.stat.is_skip=!0,"none"==e.kag.layer.layer_event.css("display")||e.kag.ftag.nextOrder(),t.stopPropagation()}),a.find(".menu_close").click(function(t){a.hide(),1==e.kag.stat.visible_menu_button&&$(".button_menu").show(),t.stopPropagation()}),a.find(".menu_window_close").click(function(t){e.kag.layer.hideMessageLayers(),a.hide(),1==e.kag.stat.visible_menu_button&&$(".button_menu").show(),t.stopPropagation()}),a.find(".menu_save").click(function(t){1!=n&&(n=!0,e.displaySave(),t.stopPropagation())}),a.find(".menu_load").click(function(t){1!=n&&(n=!0,e.displayLoad(),t.stopPropagation())}),a.find(".menu_back_title").click(function(){e.kag.backTitle()}),$.preloadImgCallback(i,function(){a.fadeIn(300),$(".button_menu").hide()},e)})},displaySave:function(t){var e=this;this.kag.stat.is_skip=!1;for(var a=e.getSaveData().data,n=(e.kag.layer.getMenuLayer(),0);n<a.length;n++)a[n].num=n;this.kag.html("save",{array_save:a,novel:$.novel},function(a){var n=$(a);n.find(".save_list").css("font-family",e.kag.config.userFace),n.find(".save_display_area").each(function(){$(this).click(function(a){var n=$(this).attr("data-num");e.snap=null;var i=e.kag.layer.getMenuLayer();i.hide(),i.empty(),1==e.kag.stat.visible_menu_button&&$(".button_menu").show(),e.doSave(n,function(){"function"==typeof t&&t()})})}),n.find(".button_smart").hide(),"pc"!=$.userenv()&&(n.find(".button_smart").show(),n.find(".button_arrow_up").click(function(){var t=n.find(".area_save_list").scrollTop()-160;i.find(".area_save_list").animate({scrollTop:t},{queue:!1})}),n.find(".button_arrow_down").click(function(){var t=n.find(".area_save_list").scrollTop()+160;n.find(".area_save_list").animate({scrollTop:t},{queue:!1})}));var i=e.kag.layer.getMenuLayer();e.setMenu(n,t)})},doSave:function(t,e){var a=this.getSaveData(),n={},i=this;null==this.snap?this.snapSave(this.kag.stat.current_save_str,function(){(n=i.snap).save_date=$.getNowDate()+"　"+$.getNowTime(),a.data[t]=n,$.setStorage(i.kag.config.projectID+"_tyrano_data",a,i.kag.config.configSave),"function"==typeof e&&e()}):"function"==typeof e&&e()},setQuickSave:function(){var t=this,e=t.kag.stat.current_save_str;t.kag.menu.snapSave(e,function(){var e=t.snap;e.save_date=$.getNowDate()+"　"+$.getNowTime(),$.setStorage(t.kag.config.projectID+"_tyrano_quick_save",e,t.kag.config.configSave)})},loadQuickSave:function(){var t=$.getStorage(this.kag.config.projectID+"_tyrano_quick_save",this.kag.config.configSave);if(!t)return!1;t=JSON.parse(t),this.loadGameData($.extend(!0,{},t))},doSetAutoSave:function(){var t=this.snap;t.save_date=$.getNowDate()+"　"+$.getNowTime(),$.setStorage(this.kag.config.projectID+"_tyrano_auto_save",t,this.kag.config.configSave)},loadAutoSave:function(){var t=$.getStorage(this.kag.config.projectID+"_tyrano_auto_save",this.kag.config.configSave);if(!t)return!1;t=JSON.parse(t),this.loadGameData($.extend(!0,{},t),{auto_next:"yes"})},snapSave:function(t,e,a){var n=this,i=n.kag.ftag.current_order_index-1,s=$.extend(!0,{},$.cloneObject(n.kag.stat));if(void 0===a&&(a=this.kag.config.configThumbnail),"false"==a){var o={};o.title=t,o.stat=s,o.current_order_index=i,o.save_date=$.getNowDate()+"　"+$.getNowTime(),o.img_data="";var r=n.kag.layer.getLayeyHtml();o.layer=r,n.snap=$.extend(!0,{},$.cloneObject(o)),e&&e()}else $("#tyrano_base").find(".layer_blend_mode").css("display","none"),setTimeout(function(){var a=function(a){var o={};o.title=t,o.stat=s,o.current_order_index=i,o.save_date=$.getNowDate()+"　"+$.getNowTime(),o.img_data=a;var r=n.kag.layer.getLayeyHtml();o.layer=r,n.snap=$.extend(!0,{},$.cloneObject(o)),e&&e()};if(""!=n.kag.stat.save_img){var o=new Image;o.src=s.save_img,o.onload=function(){var t=document.createElement("canvas");t.width=n.kag.config.scWidth,t.height=n.kag.config.scHeight,t.getContext("2d").drawImage(o,0,0);var e=n.createImgCode(t);a(e)}}else{let t,e,i=document.createElement("canvas"),s=i.getContext("2d"),o=document.querySelectorAll("video");for(let a=0,n=o.length;a<n;a++){const n=o[a];try{t=n.videoWidth,e=n.videoHeight,i.style.left=n.style.left,i.style.top=n.style.top,i.style.width=n.style.width,i.style.height=n.style.height,i.width=t,i.height=e,s.fillRect(0,0,t,e),s.drawImage(n,0,0,t,e),n.style.backgroundImage=`url(${i.toDataURL()})`,n.style.backgroundSize="cover",n.classList.add("tmp_video_canvas"),s.clearRect(0,0,t,e)}catch(t){continue}}var r=$("#tyrano_base"),c=r.css("left"),l=r.css("top"),u=r.css("transform");r.css("left",0),r.css("top",0),r.css("transform","");var g={height:n.kag.config.scHeight,width:n.kag.config.scWidth};html2canvas(r.get(0),g).then(function(t){$("#tyrano_base").find(".layer_blend_mode").css("display",""),$("#tyrano_base").find(".tmp_video_canvas").css("backgroundImage","");var e=n.createImgCode(t);a(e)}),r.hide(),r.css("left",c),r.css("top",l),r.css("transform",u),r.show()}},20)},createImgCode:function(t){var e=this.kag.config.configThumbnailQuality;return"low"==e?t.toDataURL("image/jpeg",.3):"middle"==e?t.toDataURL("image/jpeg",.7):t.toDataURL()},setGameSleep:function(t){this.kag.tmp.sleep_game_next=!!t,this.kag.tmp.sleep_game=this.snap},displayLoad:function(t){var e=this;this.kag.stat.is_skip=!1;for(var a=e.getSaveData().data,n=(e.kag.layer.getMenuLayer(),0);n<a.length;n++)a[n].num=n;this.kag.html("load",{array_save:a,novel:$.novel},function(n){var i=$(n);i.find(".save_list").css("font-family",e.kag.config.userFace),i.find(".save_display_area").each(function(){$(this).click(function(t){var n=$(this).attr("data-num");if(""!=a[n].save_date){e.snap=null,e.loadGame(n);var i=e.kag.layer.getMenuLayer();i.hide(),i.empty(),1==e.kag.stat.visible_menu_button&&$(".button_menu").show()}})}),i.find(".button_smart").hide(),"pc"!=$.userenv()&&(i.find(".button_smart").show(),i.find(".button_arrow_up").click(function(){var t=i.find(".area_save_list").scrollTop()-160;s.find(".area_save_list").animate({scrollTop:t},{queue:!1})}),i.find(".button_arrow_down").click(function(){var t=i.find(".area_save_list").scrollTop()+160;i.find(".area_save_list").animate({scrollTop:t},{queue:!1})}));var s=e.kag.layer.getMenuLayer();e.setMenu(i,t)})},loadGame:function(t){var e=this.getSaveData().data;if(""!=e[t].save_date){var a="no";1==e[t].stat.load_auto_next&&(e[t].stat.load_auto_next=!1,a="yes"),this.loadGameData($.extend(!0,{},e[t]),{auto_next:a})}},loadGameData:function(t,e){var a="no";if(void 0===e?e={bgm_over:"false"}:void 0===e.bgm_over&&(e.bgm_over="false"),e.auto_next&&(a=e.auto_next),"undefined"!=typeof Live2Dcanvas)for(model_id in Live2Dcanvas)Live2Dcanvas[model_id]&&(Live2Dcanvas[model_id].check_delete=2,Live2D.deleteBuffer(Live2Dcanvas[model_id].modelno),delete Live2Dcanvas[model_id]);if(this.kag.layer.setLayerHtml(t.layer),this.kag.stat=t.stat,1==this.kag.stat.is_strong_stop?a="stop":this.kag.stat.is_strong_stop=!1,this.kag.setTitle(this.kag.stat.title),"false"==e.bgm_over){var n=this.kag.tmp.map_se;for(var i in n)n[i]&&this.kag.ftag.startTag("stopse",{stop:"true",buf:i});var s=this.kag.tmp.map_bgm;for(var i in s)this.kag.ftag.startTag("stopbgm",{stop:"true",buf:i});if(""!=this.kag.stat.current_bgm){var o={loop:"true",storage:this.kag.stat.current_bgm,stop:"true"};""!=this.kag.stat.current_bgm_vol&&(o.volume=this.kag.stat.current_bgm_vol),this.kag.ftag.startTag("playbgm",o)}for(i in this.kag.stat.current_se){var r=this.kag.stat.current_se[i];r.stop="true",this.kag.ftag.startTag("playse",r)}}if(this.kag.stat.cssload)for(file in this.kag.stat.cssload){var c='<link rel="stylesheet" href="'+file+"?"+Math.floor(1e7*Math.random())+'">';$("head link:last").after(c)}else this.kag.stat.cssload={};if(this.kag.stat.current_bgmovie||(this.kag.stat.current_bgmovie={storage:"",volume:""}),"true"==this.kag.config.useCamera)for(i in $(".layer_camera").css({"-animation-name":"","-animation-duration":"","-animation-play-state":"","-animation-delay":"","-animation-iteration-count":"","-animation-direction":"","-animation-fill-mode":"","-animation-timing-function":""}),this.kag.stat.current_camera){var l={frames:{"0%":{trans:this.kag.stat.current_camera[i]},"100%":{trans:this.kag.stat.current_camera[i]}},config:{duration:"5ms",state:"running",easing:"ease"},complete:function(){}};"layer_camera"==i?($(".layer_camera").css("-webkit-transform-origin","center center"),setTimeout(function(){$(".layer_camera").a3d(l)},1)):($("."+i+"_fore").css("-webkit-transform-origin","center center"),setTimeout(function(){$("."+i+"_fore").a3d(l)},1))}if($(".tyrano_base").find("video").remove(),this.kag.tmp.video_playing=!1,""!=this.kag.stat.current_bgmovie.storage){o={storage:this.kag.stat.current_bgmovie.storage,volume:this.kag.stat.current_bgmovie.volume,stop:"true"};this.kag.tmp.video_playing=!1,this.kag.ftag.startTag("bgmovie",o)}""!=this.kag.stat.current_bgcamera&&(this.kag.stat.current_bgcamera.stop="true",this.kag.ftag.startTag("bgcamera",this.kag.stat.current_bgcamera)),this.kag.setCursor(this.kag.stat.current_cursor),1==this.kag.stat.visible_menu_button?$(".button_menu").show():$(".button_menu").hide(),$(".event-setting-element").each(function(){var t=$(this),e=t.attr("data-event-tag"),a=JSON.parse(t.attr("data-event-pm"));object(tyrano.plugin.kag.tag[e]).setEvent(t,a)});var u={name:"call",pm:{storage:"make.ks",auto_next:a},val:""};this.kag.clearTmpVariable(),this.kag.ftag.nextOrderWithIndex(t.current_order_index,t.stat.current_scenario,!0,u,"yes")},setMenu:function(t,e){var a=this,n=this.kag.layer.getMenuLayer();t.find(".menu_close").click(function(t){n.fadeOut(300,function(){n.empty(),"function"==typeof e&&e()}),1==a.kag.stat.visible_menu_button&&$(".button_menu").show()}),t.hide(),n.append(t),n.show(),$.preloadImgCallback(n,function(){t.fadeIn(300),n.find(".block_menu").fadeOut(300)},a)},hideMenu:function(){},getSaveData:function(){var t=$.getStorage(this.kag.config.projectID+"_tyrano_data",this.kag.config.configSave);if(t)return JSON.parse(t);t=new Array;for(var e={kind:"save"},a=this.kag.config.configSaveSlotNum||5,n=0;n<a;n++){var i={};i.title=$.lang("not_saved"),i.current_order_index=0,i.save_date="",i.img_data="",i.stat={},t.push(i)}return e.data=t,e},displayLog:function(){var t=this;this.kag.stat.is_skip=!1;$("<div></div>");this.kag.html("backlog",{novel:$.novel},function(e){var a=$(e),n=t.kag.layer.getMenuLayer();n.empty(),n.append(a),n.find(".menu_close").click(function(){n.fadeOut(300,function(){n.empty()}),1==t.kag.stat.visible_menu_button&&$(".button_menu").show()}),n.find(".button_smart").hide(),"pc"!=$.userenv()&&(n.find(".button_smart").show(),n.find(".button_arrow_up").click(function(){var t=n.find(".log_body").scrollTop()-60;n.find(".log_body").animate({scrollTop:t},{queue:!1})}),n.find(".button_arrow_down").click(function(){var t=n.find(".log_body").scrollTop()+60;n.find(".log_body").animate({scrollTop:t},{queue:!1})}));for(var i="",s=t.kag.variable.tf.system.backlog,o=0;o<s.length;o++)i+=s[o]+"<br />";n.find(".log_body").html(i),n.find(".log_body").css("font-family",t.kag.config.userFace),$.preloadImgCallback(n,function(){n.fadeIn(300),n.find(".log_body").scrollTop(9999999999)},t),$(".button_menu").hide()})},screenFull:function(){var t=document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.fullScreenElement||!1,e=document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||!1,a=document.body;e&&(a.requestFullscreen?t?document.exitFullscreen():a.requestFullscreen():a.webkitRequestFullscreen?t?document.webkitExitFullscreen():a.webkitRequestFullscreen():a.mozRequestFullScreen?t?document.mozCancelFullScreen():a.mozRequestFullScreen():a.msRequestFullscreen&&(t?document.msExitFullscreen():a.msRequestFullscreen()))},test:function(){}};
